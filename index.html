<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Steam Lua Generator Web</title>
    
    <link rel="stylesheet" href="https://pyscript.net/releases/2024.1.1/core.css" />
    <script type="module" src="https://pyscript.net/releases/2024.1.1/core.js"></script>

    <style>
        :root {
            --bg: #0f111a;
            --card: #1a1c2a;
            --accent: #0078d4;
            --text: #ffffff;
            --text-dim: #94a3b8;
            --success: #10b981;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            display: flex;
            justify-content: center;
            padding: 20px;
        }

        .container {
            width: 100%;
            max-width: 800px;
            background: var(--card);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
        }

        h1 { font-size: 1.5rem; margin-bottom: 20px; text-align: center; color: var(--accent); }

        .search-box {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        input {
            flex: 1;
            padding: 12px;
            border-radius: 6px;
            border: 1px solid #334155;
            background: #0f111a;
            color: white;
            outline: none;
        }

        input:focus { border-color: var(--accent); }

        #results {
            list-style: none;
            padding: 0;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #334155;
            border-radius: 6px;
            margin-bottom: 20px;
        }

        #results li {
            padding: 10px 15px;
            border-bottom: 1px solid #334155;
            cursor: pointer;
            transition: background 0.2s;
        }

        #results li:hover { background: #2d314d; }

        .status {
            font-size: 0.9rem;
            color: var(--text-dim);
            margin-bottom: 10px;
            text-align: center;
        }

        #log {
            background: #000;
            color: var(--success);
            font-family: 'Consolas', monospace;
            padding: 15px;
            border-radius: 6px;
            height: 150px;
            overflow-y: auto;
            font-size: 0.85rem;
        }

        .loading-spinner {
            text-align: center;
            padding: 20px;
            color: var(--accent);
        }
    </style>
</head>
<body>

<div class="container">
    <h1>ðŸŽ® Steam Lua Generator</h1>
    
    <div id="status" class="status">Chargement de l'environnement Python...</div>
    
    <div class="search-box">
        <input type="text" id="search-input" placeholder="Rechercher un jeu (Nom ou AppID)..." disabled>
    </div>

    <ul id="results"></ul>

    <div id="log">Bienvenue. En attente du chargement...</div>
</div>

<script type="py">
import json
import asyncio
from pyodide.http import pyfetch
from pyscript import display, document

DEPOT_KEYS_URL = "https://raw.githubusercontent.com/SteamAutoCracks/ManifestHub/refs/heads/main/depotkeys.json"
APPID_LIST_URL = "https://raw.githubusercontent.com/dgibbs64/SteamCMD-AppID-List/refs/heads/main/steamcmd_appid.json"

class WebGenerator:
    def __init__(self):
        self.depot_keys = {}
        self.app_list = {}
        self.app_names = {}
        self.app_depots = {}

    async def load_data(self):
        self.log("ðŸ“¥ TÃ©lÃ©chargement des bases de donnÃ©es...")
        
        # RÃ©cupÃ©ration des clÃ©s
        resp_keys = await pyfetch(DEPOT_KEYS_URL)
        self.depot_keys = await resp_keys.json()
        
        # RÃ©cupÃ©ration de la liste Steam
        resp_apps = await pyfetch(APPID_LIST_URL)
        data = await resp_apps.json()
        
        for app in data['applist']['apps']:
            self.app_list[app['appid']] = app['name']
            self.app_names[app['appid']] = app['name']

        self.log("ðŸ”— Mapping intelligent (calcul identique au script Python)...")
        # Laisser le navigateur respirer pendant le gros calcul
        await asyncio.sleep(0.1)
        self.app_depots = self.smart_depot_mapping()
        
        document.getElementById("status").innerText = "âœ… PrÃªt ! Recherche identique au script original."
        document.getElementById("search-input").disabled = False
        self.log(f"âœ… {len(self.app_depots)} jeux rÃ©pertoriÃ©s.")

    def find_best_appid_for_depot(self, depot_id):
        # Logique identique au script original
        if depot_id in self.app_list:
            return depot_id
        
        best_appid = None
        min_distance = float('inf')
        
        # Range identique : -50 Ã  +10
        for appid in range(max(1, depot_id - 50), depot_id + 10):
            if appid in self.app_list:
                distance = abs(depot_id - appid)
                if appid <= depot_id:
                    distance *= 0.8 # PrioritÃ© aux IDs infÃ©rieurs
                
                if distance < min_distance:
                    min_distance = distance
                    best_appid = appid
        return best_appid

    def smart_depot_mapping(self):
        from collections import defaultdict
        app_depots = defaultdict(list)
        
        # Trier les depots comme dans l'original
        depot_ids = sorted([int(did) for did in self.depot_keys.keys()])
        
        for depot_id in depot_ids:
            # VÃ©rifier que la clÃ© n'est pas vide
            if self.depot_keys[str(depot_id)]:
                appid = self.find_best_appid_for_depot(depot_id)
                if appid:
                    app_depots[appid].append(depot_id)
        
        return dict(app_depots)

    def log(self, msg):
        log_el = document.getElementById("log")
        log_el.innerHTML += f"<div>> {msg}</div>"
        log_el.scrollTop = log_el.scrollHeight

generator = WebGenerator()

async def init():
    await generator.load_data()

async def on_search(event):
    query = event.target.value.lower()
    results_ul = document.getElementById("results")
    results_ul.innerHTML = ""
    
    if len(query) < 2: return

    count = 0
    # On trie les rÃ©sultats pour que Aero GPX apparaisse bien
    for appid in sorted(generator.app_depots.keys()):
        name = generator.app_names.get(appid, "Inconnu")
        if query in name.lower() or query in str(appid):
            depots = generator.app_depots[appid]
            li = document.createElement("li")
            li.innerHTML = f"<strong>{name}</strong> <span style='color: #94a3b8; font-size: 0.8em;'>(AppID: {appid})</span>"
            li.onclick = lambda e, aid=appid, dpts=depots: generate_lua(aid, dpts)
            results_ul.appendChild(li)
            count += 1
        if count > 40: break

def generate_lua(appid, depots):
    generator.log(f"ðŸ“„ CrÃ©ation du fichier pour {appid}...")
    lua = [f"addappid({appid})"]
    for d in sorted(depots):
        key = generator.depot_keys.get(str(d))
        lua.append(f'addappid({d},0,"{key}")')
    
    content = "\n".join(lua)
    
    from js import Blob, document, URL
    blob = Blob.new([content], {type: 'text/plain'})
    url = URL.createObjectURL(blob)
    
    link = document.createElement("a")
    link.href = url
    link.download = f"{appid}.lua"
    link.click()
    generator.log(f"âœ… TÃ©lÃ©chargÃ© : {appid}.lua")

document.getElementById("search-input").oninput = on_search
asyncio.ensure_future(init())
</script>

</body>
</html>
